$(function(){
  var drag_opts = {
    handle: ".handle",
    //helper: "clone",
    cursorAt: {top: 48,left: 48},
    connectToSortable: "#tray ol",
    appendTo: "body",
    helper: function(){
      var asset = $(this).clone();
      asset.css("width",96);
      asset.css("height",96);
      return $(asset);
    },
    start:function(e, ui) {
      $('#tray ol').addClass("active");
    },
    stop:function(e, ui) {
      $(this).parent().parent().parent().parent().find(".content .slot_asset").html("Drop Asset here!");
      $(this).parent().parent().parent().parent().find(".name a").remove();
      $(this).parent().parent().parent().parent().find(".name .drop_asset").remove();
      $('#tray ol').removeClass("active");
    }
  }
  $('.wysiwyg').droppable({
    accept:'.asset',
    activeClass:'active',
    hoverClass:'hover',
    drop:function(ev,ui){
      var id;
      var asset = $(ui.draggable).clone();
      if ($(ui.draggable).attr("rel") != "undefined") {
        id = $(ui.draggable).attr("rel");
        asset.find("input").remove();
        asset.attr("id", "asset_" + id);
      } else {
        id = $(ui.draggable).attr("id").split('_')[1];
      }
      $(this).find("input").attr("value",id);
      $(this).find("textarea").wysiwyg("destroy");
      $(this).find("textarea").hide();
      $(this).find(".preview").hide();
      $(this).find(".name select").val("asset");
      $(this).find(".slot_asset").load('/asset/'+id+'/preview', function(){
        resize_slots();
        $(".asset").draggable(drag_opts);
      });
      edit_link = '<%= image_tag("fassets_core/edit.png", :alt => "Edit", :title => "Edit", :width => "15", :height => "15") %>'
      drop_link = '<%= image_tag("fassets_core/delete.png", :width => "15", :height => "15", :class => "drop_asset") %>'
      if ($(this).find(".name a").length){
        $(this).find(".name a").html(edit_link);
      } else {
        $(this).find(".name").append(edit_link);
      }
      if (!$(this).find(".name .drop_asset").length){
        $(this).find(".name").append(drop_link);
        $(".drop_asset").click(function(){
          //$(this).parent().parent().find("input").val("");
          $(this).parent().parent().find(".slot_asset").html("Drop Asset here!");
          $(this).parent().parent().find(".name a").remove();
          $(this).parent().parent().find(".name .drop_asset").remove();
          $('#edit_warning').css('visibility','visible');
        });
      }
      $(this).find(".slot_asset").show()
      $('#edit_warning').css('visibility','visible');
    },
  });
  $('.slot .name select').change(function(){
    if ($(this).parent().parent().find(".wysiwyg").length != 0){
      var content = $(this).parent().parent().find(".wysiwyg");
      var text = content.parent().find("textarea");
      var asset = content.parent().find(".slot_asset");
    }else{
      var text = $(this).parent().parent().find("textarea");
      var asset = $(this).parent().parent().find(".slot_asset"); 
    }
    if ($(this).val() == "markup") {
      asset.hide();
      text.show();
      text.wysiwyg(wysiwyg_options);
      resize_slots();
    } else {
      resize_slots();
      asset.show();
      text.wysiwyg("destroy");
      text.hide();
    }
  });
  $(".drop_asset").click(function(){
    $(this).parent().parent().find(".content input").val("");
    $(this).parent().parent().find(".content .slot_asset").html("Drop Asset here!");
    $(this).parent().parent().find(".name a").remove();
    $(this).parent().parent().find(".name .drop_asset").remove();
    $('#edit_warning').css('visibility','visible');
  });
  var resize_slots = function(){
    height = $(window).height();
    width = $(window).width();
    $("#slot_top").css("height", height*0.35 + 'px');
    $("#slot_top").css("width", width*0.67 + 'px');
    $("#slot_bottom").css("height", height*0.35 + 'px');
    $("#slot_bottom").css("width", width*0.67 + 'px');
    $("#slot_topleft").css("height", height*0.35 + 'px');
    $("#slot_topleft").css("width", width*0.33 + 'px');
    $("#slot_topright").css("height", height*0.35 + 'px');
    $("#slot_topright").css("width", width*0.33 + 'px');
    $("#slot_left").css("height", height*0.7 + 'px');
    $("#slot_left").css("width", width*0.33 + 'px');
    $("#slot_right").css("height", height*0.7 + 'px');
    $("#slot_right").css("width", width*0.33 + 'px');
    $("#slot_center").css("height", height*0.7 + 'px');
    $("#slot_center").css("width", width*0.67 + 'px');
    $("#slot_subtitle").css("height", height*0.35 + 'px');
    $("#slot_subtitle").css("width", width*0.67 + 'px');
    $("#slot_centertitle").css("height", height*0.35 + 'px');
    $("#slot_centertitle").css("width", width*0.67 + 'px');
    $("textarea").each(function(i,e) {
      parent = $(e).parent();
      $(e).css("height", parent.height()*0.9);
      $(e).css("width", parent.width()*0.9);
    });
    $(".slot .editor_content").each(function(i,e) {
      parent = $(e).parent().parent();
      $(e).css("height", parent.height()*0.80);
      $(e).css("width", parent.width()*0.985);
    });    
    $("img.fit").scaleImage({
      parent: "li",
      scale: 'fit',
      center: false
    });
    $("#slot_bottom .slot_asset img").scaleImage({
      parent: "li",
      scale: 'fit',
      center: true
    });
    $("#slot_top .slot_asset img").scaleImage({
      parent: "li",
      scale: 'fit',
      center: true
    });
    $("#slot_center .slot_asset img").scaleImage({
      parent: "li",
      scale: 'fit',
      center: true
    });
  }
  var wysiwyg_options = {
    controls: {
        strikeThrough: { visible: true },
        underline: { visible: true },
        subscript: { visible: true },
        superscript: { visible: true },
        justifyLeft: { visible: false},
        justifyCenter: { visible: false},
        justifyRight: { visible: false},
        justifyFull: { visible: false},
        subscript: { visible: false},
        superscript: { visible: false},
        createLink: { visible: false},
        insertImage: { visible: false},
        insertHorizontalRule: { visible: false},
    },
    events: {
      click: function(e){
        resize_slots();
      }     
    },
    autoSave: true,
    iFrameClass: "editor_content",
    css:  '/assets/fassets_presentations/templates/'+$("#edit_frame").attr("template")+'/editor.css'
  }
  $('.wysiwyg .slot_textarea').each(function(i,e){
    if($(e).parent().find("select").val() == "markup"){
      $(e).wysiwyg(wysiwyg_options);
    }
  });
  resize_slots();
  $(window).resize(function(){resize_slots();});
});

